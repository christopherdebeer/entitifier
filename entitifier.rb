require 'vendor/sinatra/lib/sinatra.rb'
require 'vendor/hpricot/lib/hpricot.rb'
require 'lib/hpricot_text_gsub.rb'

# FIXME: Accept HTML5 Elements
# FIXME: Ignore <?php ?> <%= %> etc.

def entityReplace(el)
  el.text_gsub! /&/, '&amp;'
  el.text_gsub! /&amp;amp;/, '&amp;' # Hacky workaround 
  el.text_gsub! /"/, '&quot;'
  el.text_gsub! /</, '&lt;'
  el.text_gsub! />/, '&gt;'
  el.text_gsub! /¡/, '&iexcl;'
  el.text_gsub! /¢/, '&cent;'
  el.text_gsub! /£/, '&pound;'
  el.text_gsub! /¤/, '&curren;'
  el.text_gsub! /¥/, '&yen;'
  el.text_gsub! /¦/, '&brvbar;'
  el.text_gsub! /§/, '&sect;'
  el.text_gsub! /¨/, '&uml;'
  el.text_gsub! /©/, '&copy;'
  el.text_gsub! /ª/, '&ordf;'
  el.text_gsub! /«/, '&laquo;'
  el.text_gsub! /¬/, '&not;'
  el.text_gsub! /®/, '&reg;'
  el.text_gsub! /¯/, '&macr;'
  el.text_gsub! /°/, '&deg;'
  el.text_gsub! /±/, '&plusmn;'
  el.text_gsub! /²/, '&sup2;'
  el.text_gsub! /³/, '&sup3;'
  el.text_gsub! /´/, '&acute;'
  el.text_gsub! /µ/, '&micro;'
  el.text_gsub! /¶/, '&para;'
  el.text_gsub! /·/, '&middot;'
  el.text_gsub! /¸/, '&cedil;'
  el.text_gsub! /¹/, '&sup1;'
  el.text_gsub! /º/, '&ordm;'
  el.text_gsub! /»/, '&raquo;'
  el.text_gsub! /¼/, '&frac14;'
  el.text_gsub! /½/, '&frac12;'
  el.text_gsub! /¾/, '&frac34;'
  el.text_gsub! /¿/, '&iquest;'
  el.text_gsub! /À/, '&Agrave;'
  el.text_gsub! /Á/, '&Aacute;'
  el.text_gsub! /Â/, '&Acirc;'
  el.text_gsub! /Ã/, '&Atilde;'
  el.text_gsub! /Ä/, '&Auml;'
  el.text_gsub! /Å/, '&Aring;'
  el.text_gsub! /Æ/, '&AElig;'
  el.text_gsub! /Ç/, '&Ccedil;'
  el.text_gsub! /È/, '&Egrave;'
  el.text_gsub! /É/, '&Eacute;'
  el.text_gsub! /Ê/, '&Ecirc;'
  el.text_gsub! /Ë/, '&Euml;'
  el.text_gsub! /Ì/, '&Igrave;'
  el.text_gsub! /Í/, '&Iacute;'
  el.text_gsub! /Î/, '&Icirc;'
  el.text_gsub! /Ï/, '&Iuml;'
  el.text_gsub! /Ð/, '&ETH;'
  el.text_gsub! /Ñ/, '&Ntilde;'
  el.text_gsub! /Ò/, '&Ograve;'
  el.text_gsub! /Ó/, '&Oacute;'
  el.text_gsub! /Ô/, '&Ocirc;'
  el.text_gsub! /Õ/, '&Otilde;'
  el.text_gsub! /Ö/, '&Ouml;'
  el.text_gsub! /×/, '&times;'
  el.text_gsub! /Ø/, '&Oslash;'
  el.text_gsub! /Ù/, '&Ugrave;'
  el.text_gsub! /Ú/, '&Uacute;'
  el.text_gsub! /Û/, '&Ucirc;'
  el.text_gsub! /Ü/, '&Uuml;'
  el.text_gsub! /Ý/, '&Yacute;'
  el.text_gsub! /Þ/, '&THORN;'
  el.text_gsub! /ß/, '&szlig;'
  el.text_gsub! /à/, '&agrave;'
  el.text_gsub! /á/, '&aacute;'
  el.text_gsub! /â/, '&acirc;'
  el.text_gsub! /ã/, '&atilde;'
  el.text_gsub! /ä/, '&auml;'
  el.text_gsub! /å/, '&aring;'
  el.text_gsub! /æ/, '&aelig;'
  el.text_gsub! /ç/, '&ccedil;'
  el.text_gsub! /è/, '&egrave;'
  el.text_gsub! /é/, '&eacute;'
  el.text_gsub! /ê/, '&ecirc;'
  el.text_gsub! /ë/, '&euml;'
  el.text_gsub! /ì/, '&igrave;'
  el.text_gsub! /í/, '&iacute;'
  el.text_gsub! /î/, '&icirc;'
  el.text_gsub! /ï/, '&iuml;'
  el.text_gsub! /ð/, '&eth;'
  el.text_gsub! /ñ/, '&ntilde;'
  el.text_gsub! /ò/, '&ograve;'
  el.text_gsub! /ó/, '&oacute;'
  el.text_gsub! /ô/, '&ocirc;'
  el.text_gsub! /õ/, '&otilde;'
  el.text_gsub! /ö/, '&ouml;'
  el.text_gsub! /÷/, '&divide;'
  el.text_gsub! /ø/, '&oslash;'
  el.text_gsub! /ù/, '&ugrave;'
  el.text_gsub! /ú/, '&uacute;'
  el.text_gsub! /û/, '&ucirc;'
  el.text_gsub! /ü/, '&uuml;'
  el.text_gsub! /ý/, '&yacute;'
  el.text_gsub! /þ/, '&thorn;'
  el.text_gsub! /ÿ/, '&yuml;'
  el.text_gsub! /Œ/, '&OElig;'
  el.text_gsub! /œ/, '&oelig;'
  el.text_gsub! /Š/, '&Scaron;'
  el.text_gsub! /š/, '&scaron;'
  el.text_gsub! /Ÿ/, '&Yuml;'
  el.text_gsub! /ƒ/, '&fnof;'
  el.text_gsub! /ˆ/, '&circ;'
  el.text_gsub! /˜/, '&tilde;'
  el.text_gsub! /Α/, '&Alpha;'
  el.text_gsub! /Β/, '&Beta;'
  el.text_gsub! /Γ/, '&Gamma;'
  el.text_gsub! /Δ/, '&Delta;'
  el.text_gsub! /Ε/, '&Epsilon;'
  el.text_gsub! /Ζ/, '&Zeta;'
  el.text_gsub! /Η/, '&Eta;'
  el.text_gsub! /Θ/, '&Theta;'
  el.text_gsub! /Ι/, '&Iota;'
  el.text_gsub! /Κ/, '&Kappa;'
  el.text_gsub! /Λ/, '&Lambda;'
  el.text_gsub! /Μ/, '&Mu;'
  el.text_gsub! /Ν/, '&Nu;'
  el.text_gsub! /Ξ/, '&Xi;'
  el.text_gsub! /Ο/, '&Omicron;'
  el.text_gsub! /Π/, '&Pi;'
  el.text_gsub! /Ρ/, '&Rho;'
  el.text_gsub! /Σ/, '&Sigma;'
  el.text_gsub! /Τ/, '&Tau;'
  el.text_gsub! /Υ/, '&Upsilon;'
  el.text_gsub! /Φ/, '&Phi;'
  el.text_gsub! /Χ/, '&Chi;'
  el.text_gsub! /Ψ/, '&Psi;'
  el.text_gsub! /Ω/, '&Omega;'
  el.text_gsub! /α/, '&alpha;'
  el.text_gsub! /β/, '&beta;'
  el.text_gsub! /γ/, '&gamma;'
  el.text_gsub! /δ/, '&delta;'
  el.text_gsub! /ε/, '&epsilon;'
  el.text_gsub! /ζ/, '&zeta;'
  el.text_gsub! /η/, '&eta;'
  el.text_gsub! /θ/, '&theta;'
  el.text_gsub! /ι/, '&iota;'
  el.text_gsub! /κ/, '&kappa;'
  el.text_gsub! /λ/, '&lambda;'
  el.text_gsub! /μ/, '&mu;'
  el.text_gsub! /ν/, '&nu;'
  el.text_gsub! /ξ/, '&xi;'
  el.text_gsub! /ο/, '&omicron;'
  el.text_gsub! /π/, '&pi;'
  el.text_gsub! /ρ/, '&rho;'
  el.text_gsub! /ς/, '&sigmaf;'
  el.text_gsub! /σ/, '&sigma;'
  el.text_gsub! /τ/, '&tau;'
  el.text_gsub! /υ/, '&upsilon;'
  el.text_gsub! /φ/, '&phi;'
  el.text_gsub! /χ/, '&chi;'
  el.text_gsub! /ψ/, '&psi;'
  el.text_gsub! /ω/, '&omega;'
  el.text_gsub! /ϑ/, '&thetasym;'
  el.text_gsub! /ϒ/, '&upsih;'
  el.text_gsub! /ϖ/, '&piv;'
  el.text_gsub! /–/, '&ndash;'
  el.text_gsub! /—/, '&mdash;'
  el.text_gsub! /‘/, '&lsquo;'
  el.text_gsub! /’/, '&rsquo;'
  el.text_gsub! /‚/, '&sbquo;'
  el.text_gsub! /“/, '&ldquo;'
  el.text_gsub! /”/, '&rdquo;'
  el.text_gsub! /„/, '&bdquo;'
  el.text_gsub! /†/, '&dagger;'
  el.text_gsub! /‡/, '&Dagger;'
  el.text_gsub! /•/, '&bull;'
  el.text_gsub! /…/, '&hellip;'
  el.text_gsub! /‰/, '&permil;'
  el.text_gsub! /′/, '&prime;'
  el.text_gsub! /″/, '&Prime;'
  el.text_gsub! /‹/, '&lsaquo;'
  el.text_gsub! /›/, '&rsaquo;'
  el.text_gsub! /‾/, '&oline;'
  el.text_gsub! /⁄/, '&frasl;'
  el.text_gsub! /€/, '&euro;'
  el.text_gsub! /ℑ/, '&image;'
  el.text_gsub! /℘/, '&weierp;'
  el.text_gsub! /ℜ/, '&real;'
  el.text_gsub! /™/, '&trade;'
  el.text_gsub! /ℵ/, '&alefsym;'
  el.text_gsub! /←/, '&larr;'
  el.text_gsub! /↑/, '&uarr;'
  el.text_gsub! /→/, '&rarr;'
  el.text_gsub! /↓/, '&darr;'
  el.text_gsub! /↔/, '&harr;'
  el.text_gsub! /↵/, '&crarr;'
  el.text_gsub! /⇐/, '&lArr;'
  el.text_gsub! /⇑/, '&uArr;'
  el.text_gsub! /⇒/, '&rArr;'
  el.text_gsub! /⇓/, '&dArr;'
  el.text_gsub! /⇔/, '&hArr;'
  el.text_gsub! /∀/, '&forall;'
  el.text_gsub! /∂/, '&part;'
  el.text_gsub! /∃/, '&exist;'
  el.text_gsub! /∅/, '&empty;'
  el.text_gsub! /∇/, '&nabla;'
  el.text_gsub! /∈/, '&isin;'
  el.text_gsub! /∉/, '&notin;'
  el.text_gsub! /∋/, '&ni;'
  el.text_gsub! /∏/, '&prod;'
  el.text_gsub! /∑/, '&sum;'
  el.text_gsub! /−/, '&minus;'
  el.text_gsub! /∗/, '&lowast;'
  el.text_gsub! /√/, '&radic;'
  el.text_gsub! /∝/, '&prop;'
  el.text_gsub! /∞/, '&infin;'
  el.text_gsub! /∠/, '&ang;'
  el.text_gsub! /∧/, '&and;'
  el.text_gsub! /∨/, '&or;'
  el.text_gsub! /∩/, '&cap;'
  el.text_gsub! /∪/, '&cup;'
  el.text_gsub! /∫/, '&int;'
  el.text_gsub! /∴/, '&there4;'
  el.text_gsub! /∼/, '&sim;'
  el.text_gsub! /≅/, '&cong;'
  el.text_gsub! /≈/, '&asymp;'
  el.text_gsub! /≠/, '&ne;'
  el.text_gsub! /≡/, '&equiv;'
  el.text_gsub! /≤/, '&le;'
  el.text_gsub! /≥/, '&ge;'
  el.text_gsub! /⊂/, '&sub;'
  el.text_gsub! /⊃/, '&sup;'
  el.text_gsub! /⊄/, '&nsub;'
  el.text_gsub! /⊆/, '&sube;'
  el.text_gsub! /⊇/, '&supe;'
  el.text_gsub! /⊕/, '&oplus;'
  el.text_gsub! /⊗/, '&otimes;'
  el.text_gsub! /⊥/, '&perp;'
  el.text_gsub! /⋅/, '&sdot;'
  el.text_gsub! /⌈/, '&lceil;'
  el.text_gsub! /⌉/, '&rceil;'
  el.text_gsub! /⌊/, '&lfloor;'
  el.text_gsub! /⌋/, '&rfloor;'
  el.text_gsub! /〈/, '&lang;'
  el.text_gsub! /〉/, '&rang;'
  el.text_gsub! /◊/, '&loz;'
  el.text_gsub! /♠/, '&spades;'
  el.text_gsub! /♣/, '&clubs;'
  el.text_gsub! /♥/, '&hearts;'
  el.text_gsub! /♦/, '&diams;'
end

def textReplace(str)
  str.gsub! /&/, '&amp;'
  str.gsub! /&amp;amp;/, '&amp;'
  str.gsub! /"/, '&quot;'
  str.gsub! /</, '&lt;'
  str.gsub! />/, '&gt;'
  str.gsub! /¡/, '&iexcl;'
  str.gsub! /¢/, '&cent;'
  str.gsub! /£/, '&pound;'
  str.gsub! /¤/, '&curren;'
  str.gsub! /¥/, '&yen;'
  str.gsub! /¦/, '&brvbar;'
  str.gsub! /§/, '&sect;'
  str.gsub! /¨/, '&uml;'
  str.gsub! /©/, '&copy;'
  str.gsub! /ª/, '&ordf;'
  str.gsub! /«/, '&laquo;'
  str.gsub! /¬/, '&not;'
  str.gsub! /®/, '&reg;'
  str.gsub! /¯/, '&macr;'
  str.gsub! /°/, '&deg;'
  str.gsub! /±/, '&plusmn;'
  str.gsub! /²/, '&sup2;'
  str.gsub! /³/, '&sup3;'
  str.gsub! /´/, '&acute;'
  str.gsub! /µ/, '&micro;'
  str.gsub! /¶/, '&para;'
  str.gsub! /·/, '&middot;'
  str.gsub! /¸/, '&cedil;'
  str.gsub! /¹/, '&sup1;'
  str.gsub! /º/, '&ordm;'
  str.gsub! /»/, '&raquo;'
  str.gsub! /¼/, '&frac14;'
  str.gsub! /½/, '&frac12;'
  str.gsub! /¾/, '&frac34;'
  str.gsub! /¿/, '&iquest;'
  str.gsub! /À/, '&Agrave;'
  str.gsub! /Á/, '&Aacute;'
  str.gsub! /Â/, '&Acirc;'
  str.gsub! /Ã/, '&Atilde;'
  str.gsub! /Ä/, '&Auml;'
  str.gsub! /Å/, '&Aring;'
  str.gsub! /Æ/, '&AElig;'
  str.gsub! /Ç/, '&Ccedil;'
  str.gsub! /È/, '&Egrave;'
  str.gsub! /É/, '&Eacute;'
  str.gsub! /Ê/, '&Ecirc;'
  str.gsub! /Ë/, '&Euml;'
  str.gsub! /Ì/, '&Igrave;'
  str.gsub! /Í/, '&Iacute;'
  str.gsub! /Î/, '&Icirc;'
  str.gsub! /Ï/, '&Iuml;'
  str.gsub! /Ð/, '&ETH;'
  str.gsub! /Ñ/, '&Ntilde;'
  str.gsub! /Ò/, '&Ograve;'
  str.gsub! /Ó/, '&Oacute;'
  str.gsub! /Ô/, '&Ocirc;'
  str.gsub! /Õ/, '&Otilde;'
  str.gsub! /Ö/, '&Ouml;'
  str.gsub! /×/, '&times;'
  str.gsub! /Ø/, '&Oslash;'
  str.gsub! /Ù/, '&Ugrave;'
  str.gsub! /Ú/, '&Uacute;'
  str.gsub! /Û/, '&Ucirc;'
  str.gsub! /Ü/, '&Uuml;'
  str.gsub! /Ý/, '&Yacute;'
  str.gsub! /Þ/, '&THORN;'
  str.gsub! /ß/, '&szlig;'
  str.gsub! /à/, '&agrave;'
  str.gsub! /á/, '&aacute;'
  str.gsub! /â/, '&acirc;'
  str.gsub! /ã/, '&atilde;'
  str.gsub! /ä/, '&auml;'
  str.gsub! /å/, '&aring;'
  str.gsub! /æ/, '&aelig;'
  str.gsub! /ç/, '&ccedil;'
  str.gsub! /è/, '&egrave;'
  str.gsub! /é/, '&eacute;'
  str.gsub! /ê/, '&ecirc;'
  str.gsub! /ë/, '&euml;'
  str.gsub! /ì/, '&igrave;'
  str.gsub! /í/, '&iacute;'
  str.gsub! /î/, '&icirc;'
  str.gsub! /ï/, '&iuml;'
  str.gsub! /ð/, '&eth;'
  str.gsub! /ñ/, '&ntilde;'
  str.gsub! /ò/, '&ograve;'
  str.gsub! /ó/, '&oacute;'
  str.gsub! /ô/, '&ocirc;'
  str.gsub! /õ/, '&otilde;'
  str.gsub! /ö/, '&ouml;'
  str.gsub! /÷/, '&divide;'
  str.gsub! /ø/, '&oslash;'
  str.gsub! /ù/, '&ugrave;'
  str.gsub! /ú/, '&uacute;'
  str.gsub! /û/, '&ucirc;'
  str.gsub! /ü/, '&uuml;'
  str.gsub! /ý/, '&yacute;'
  str.gsub! /þ/, '&thorn;'
  str.gsub! /ÿ/, '&yuml;'
  str.gsub! /Œ/, '&OElig;'
  str.gsub! /œ/, '&oelig;'
  str.gsub! /Š/, '&Scaron;'
  str.gsub! /š/, '&scaron;'
  str.gsub! /Ÿ/, '&Yuml;'
  str.gsub! /ƒ/, '&fnof;'
  str.gsub! /ˆ/, '&circ;'
  str.gsub! /˜/, '&tilde;'
  str.gsub! /Α/, '&Alpha;'
  str.gsub! /Β/, '&Beta;'
  str.gsub! /Γ/, '&Gamma;'
  str.gsub! /Δ/, '&Delta;'
  str.gsub! /Ε/, '&Epsilon;'
  str.gsub! /Ζ/, '&Zeta;'
  str.gsub! /Η/, '&Eta;'
  str.gsub! /Θ/, '&Theta;'
  str.gsub! /Ι/, '&Iota;'
  str.gsub! /Κ/, '&Kappa;'
  str.gsub! /Λ/, '&Lambda;'
  str.gsub! /Μ/, '&Mu;'
  str.gsub! /Ν/, '&Nu;'
  str.gsub! /Ξ/, '&Xi;'
  str.gsub! /Ο/, '&Omicron;'
  str.gsub! /Π/, '&Pi;'
  str.gsub! /Ρ/, '&Rho;'
  str.gsub! /Σ/, '&Sigma;'
  str.gsub! /Τ/, '&Tau;'
  str.gsub! /Υ/, '&Upsilon;'
  str.gsub! /Φ/, '&Phi;'
  str.gsub! /Χ/, '&Chi;'
  str.gsub! /Ψ/, '&Psi;'
  str.gsub! /Ω/, '&Omega;'
  str.gsub! /α/, '&alpha;'
  str.gsub! /β/, '&beta;'
  str.gsub! /γ/, '&gamma;'
  str.gsub! /δ/, '&delta;'
  str.gsub! /ε/, '&epsilon;'
  str.gsub! /ζ/, '&zeta;'
  str.gsub! /η/, '&eta;'
  str.gsub! /θ/, '&theta;'
  str.gsub! /ι/, '&iota;'
  str.gsub! /κ/, '&kappa;'
  str.gsub! /λ/, '&lambda;'
  str.gsub! /μ/, '&mu;'
  str.gsub! /ν/, '&nu;'
  str.gsub! /ξ/, '&xi;'
  str.gsub! /ο/, '&omicron;'
  str.gsub! /π/, '&pi;'
  str.gsub! /ρ/, '&rho;'
  str.gsub! /ς/, '&sigmaf;'
  str.gsub! /σ/, '&sigma;'
  str.gsub! /τ/, '&tau;'
  str.gsub! /υ/, '&upsilon;'
  str.gsub! /φ/, '&phi;'
  str.gsub! /χ/, '&chi;'
  str.gsub! /ψ/, '&psi;'
  str.gsub! /ω/, '&omega;'
  str.gsub! /ϑ/, '&thetasym;'
  str.gsub! /ϒ/, '&upsih;'
  str.gsub! /ϖ/, '&piv;'
  str.gsub! /–/, '&ndash;'
  str.gsub! /—/, '&mdash;'
  str.gsub! /‘/, '&lsquo;'
  str.gsub! /’/, '&rsquo;'
  str.gsub! /‚/, '&sbquo;'
  str.gsub! /“/, '&ldquo;'
  str.gsub! /”/, '&rdquo;'
  str.gsub! /„/, '&bdquo;'
  str.gsub! /†/, '&dagger;'
  str.gsub! /‡/, '&Dagger;'
  str.gsub! /•/, '&bull;'
  str.gsub! /…/, '&hellip;'
  str.gsub! /‰/, '&permil;'
  str.gsub! /′/, '&prime;'
  str.gsub! /″/, '&Prime;'
  str.gsub! /‹/, '&lsaquo;'
  str.gsub! /›/, '&rsaquo;'
  str.gsub! /‾/, '&oline;'
  str.gsub! /⁄/, '&frasl;'
  str.gsub! /€/, '&euro;'
  str.gsub! /ℑ/, '&image;'
  str.gsub! /℘/, '&weierp;'
  str.gsub! /ℜ/, '&real;'
  str.gsub! /™/, '&trade;'
  str.gsub! /ℵ/, '&alefsym;'
  str.gsub! /←/, '&larr;'
  str.gsub! /↑/, '&uarr;'
  str.gsub! /→/, '&rarr;'
  str.gsub! /↓/, '&darr;'
  str.gsub! /↔/, '&harr;'
  str.gsub! /↵/, '&crarr;'
  str.gsub! /⇐/, '&lArr;'
  str.gsub! /⇑/, '&uArr;'
  str.gsub! /⇒/, '&rArr;'
  str.gsub! /⇓/, '&dArr;'
  str.gsub! /⇔/, '&hArr;'
  str.gsub! /∀/, '&forall;'
  str.gsub! /∂/, '&part;'
  str.gsub! /∃/, '&exist;'
  str.gsub! /∅/, '&empty;'
  str.gsub! /∇/, '&nabla;'
  str.gsub! /∈/, '&isin;'
  str.gsub! /∉/, '&notin;'
  str.gsub! /∋/, '&ni;'
  str.gsub! /∏/, '&prod;'
  str.gsub! /∑/, '&sum;'
  str.gsub! /−/, '&minus;'
  str.gsub! /∗/, '&lowast;'
  str.gsub! /√/, '&radic;'
  str.gsub! /∝/, '&prop;'
  str.gsub! /∞/, '&infin;'
  str.gsub! /∠/, '&ang;'
  str.gsub! /∧/, '&and;'
  str.gsub! /∨/, '&or;'
  str.gsub! /∩/, '&cap;'
  str.gsub! /∪/, '&cup;'
  str.gsub! /∫/, '&int;'
  str.gsub! /∴/, '&there4;'
  str.gsub! /∼/, '&sim;'
  str.gsub! /≅/, '&cong;'
  str.gsub! /≈/, '&asymp;'
  str.gsub! /≠/, '&ne;'
  str.gsub! /≡/, '&equiv;'
  str.gsub! /≤/, '&le;'
  str.gsub! /≥/, '&ge;'
  str.gsub! /⊂/, '&sub;'
  str.gsub! /⊃/, '&sup;'
  str.gsub! /⊄/, '&nsub;'
  str.gsub! /⊆/, '&sube;'
  str.gsub! /⊇/, '&supe;'
  str.gsub! /⊕/, '&oplus;'
  str.gsub! /⊗/, '&otimes;'
  str.gsub! /⊥/, '&perp;'
  str.gsub! /⋅/, '&sdot;'
  str.gsub! /⌈/, '&lceil;'
  str.gsub! /⌉/, '&rceil;'
  str.gsub! /⌊/, '&lfloor;'
  str.gsub! /⌋/, '&rfloor;'
  str.gsub! /〈/, '&lang;'
  str.gsub! /〉/, '&rang;'
  str.gsub! /◊/, '&loz;'
  str.gsub! /♠/, '&spades;'
  str.gsub! /♣/, '&clubs;'
  str.gsub! /♥/, '&hearts;'
  str.gsub! /♦/, '&diams;'
  str
end

def entitify(html)
  @html = ''
  h = Hpricot(html)
  unless h.search("/html/body").empty?
    body = h.search "/html/body"
    body.each do |el|
      entityReplace(el)
    end
    html = h
  else
    html = entityReplace(h)
  end
  html
end

get '/' do
  erb :home
end

post '/direct_input' do
  @html = params[:html]
  @content = entitify(@html) if params[:text_or_html] == "html"
  @content = textReplace(@html) if params[:text_or_html] == "text"
  
  erb :display_code, :layout => false
end